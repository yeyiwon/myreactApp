import React, { useState, useEffect, useContext } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import AppBarHeader from '../LayOut/Header';
import AppBottomNav from '../LayOut/BottomNavigation';
import { Dialog, DialogActions, DialogContent, Button, Select, MenuItem, FormControl, Badge, Avatar } from '@mui/material';
import { db } from 'firebaseApp';
import { collection, doc, getDoc, getDocs, onSnapshot, query, updateDoc, where } from 'firebase/firestore';
import AuthContext from 'Context/AuthContext';
import { RiChatNewLine } from "react-icons/ri";
import { UserProps, ChatRoomProps, Message } from 'types/InterfaceTypes';
import { useCreateChatRoom } from './useCreateChatRoom';

export default function ChatList() {
  const [open, setOpen] = useState(false);
  const [selectedUserId, setSelectedUserId] = useState<string | null>(null);
  const [followingList, setFollowingList] = useState<UserProps[]>([]);
  const [chatRooms, setChatRooms] = useState<ChatRoomProps[]>([]);
  const { user } = useContext(AuthContext);
  const navigate = useNavigate();
  const { CreateRoom } = useCreateChatRoom();
  const [unreadMessagesCount, setUnreadMessagesCount] = useState<number>(0); // ÏÉÅÌÉú Ï∂îÍ∞Ä


const formatTimestamp = (timestamp?: { seconds: number }) => {
  if (!timestamp) {
    return 'No date'; 
  }

  const date = new Date(timestamp.seconds * 1000);
  const now = new Date();
  
  // Ïò§Îäò ÎÇ†Ïßú
  const isToday = date.toDateString() === now.toDateString();
  
  // ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ
  const options: Intl.DateTimeFormatOptions = {
    hour: '2-digit',
    minute: '2-digit',
  };
  
  if (isToday) {
    return date.toLocaleTimeString([], options); // Ïò§Îäò ÎÇ†ÏßúÏùº Í≤ΩÏö∞ ÏãúÍ∞ÑÎßå ÌëúÏãú
  } else {
    return date.toLocaleDateString(); // Îã§Î•∏ ÎÇ†ÏßúÏùº Í≤ΩÏö∞ ÎÇ†ÏßúÎ•º ÌëúÏãú
  }
};



// Ï±ÑÌåÖÎ∞© Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò 
// ÌùêÎ¶Ñ Ï†ïÎ¶¨ : Ï±ÑÌåÖÎ∞© Î¶¨Ïä§Ìä∏Î•º Í∞ÄÏ†∏Ïò¨ Îïê ÌòÑÏû¨ Î°úÍ∑∏Ïù∏ Îêú ÏÇ¨Ïö©ÏûêÎ•º Users ÎùºÎäî Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïª¨Î†âÏÖò ÏïàÏóêÏÑú Í≥®ÎùºÏò®Îã§ 
// Ïú†Ï†Ä Ï†ïÎ≥¥Î•º userDoc Î≥ÄÏàò ÏïàÏóê Îã¥ÏïÑ ÎÜìÍ≥† onSnapshotÏùÑ ÌïòÍ∏∞ ÏúÑÌï¥ async ÌïúÎã§ ÏΩúÎ∞± Îß§Í∞úÎ≥ÄÏàòÍ∞íÏúºÎ°ú userSnap 
  const getChatRooms = () => {
    if (user?.uid) {
      const userDoc = doc(db, 'Users', user.uid);
      // Ïú†Ï†ÄÏùò Ï†ïÎ≥¥Î•º userDocÏóê Îã¥ÏïÑÎÜìÍ≥† Î∞îÎÄî ÎïåÎßàÎã§ Ìò∏Ï∂ú
      const filterUser = onSnapshot(userDoc, async (userSnap) => {
        if (userSnap.exists()) {

          const userData = userSnap.data();
          const userChatRooms: string[] = userData.chatRooms || [];
          const chatRoomsCollection = collection(db, 'ChatRooms');
          
          const filterChatRooms = onSnapshot(chatRoomsCollection, async (chatRoomsSnapshot) => {
            const rooms = chatRoomsSnapshot.docs.filter(doc => userChatRooms.includes(doc.id))
              .map(doc => {
                const roomData = doc.data();
                return {
                  id: doc.id,
                  ...roomData,
                }as ChatRoomProps;
              });

            const resolvedRooms = await Promise.all(
              rooms.map(async (room) => {
                const otherUser = await getOtherUserInfo(room);
                const lastMessage = room.lastMessage || '';
                const unreadMessagesCount = room.unreadMessages?.[user.uid] || 0;
                const lastMessageTimestamp = room.lastMessageTimestamp || { seconds: 0 };

                return {
                  ...room,
                  otherUser,
                  lastMessage,
                  unreadMessagesCount,
                  lastMessageTimestamp,
                } as ChatRoomProps;
              })
            );

            const sortedRooms = resolvedRooms.sort((a, b) => {
              return (b.lastMessageTimestamp?.seconds || 0) - (a.lastMessageTimestamp?.seconds || 0);
            });

            setChatRooms(sortedRooms);
          });

              return () => {
                filterChatRooms();
              };
            }
          });
          return () => {
            filterUser(); // ÏûëÏóÖ ÎÅù ~
          };
        }
      };

  useEffect(() => {
    getChatRooms(); 
    getFollowingList();
    
  }, [user?.uid]);

    // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏: ÏÇ¨Ïö©ÏûêÍ∞Ä Î°úÍ∑∏Ïù∏Ìï† Îïå ÏÉàÎ°úÏö¥ Îç∞Ïù¥ÌÑ∞(Ïòà: Ï±ÑÌåÖÎ∞©, ÌåîÎ°úÏö∞ Î¶¨Ïä§Ìä∏ Îì±)Î•º Í∞ÄÏ†∏ÏôÄÏïº ÌïòÎãàÍπå. ÌòÑÏû¨ Î°úÍ∑∏Ïù∏ÎêòÏñ¥ÏûàÎäî ÏÇ¨Ïö©Ïûê Í∏∞Ï§ÄÏúºÎ°ú Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏Í∞Ä ÎêòÏñ¥ÏïºÌïòÍ∏∞ ÎïåÎ¨∏Ïóê user?.uid Í∞Ä ÎêòÎäî Í≤ÉÏûÑ 

    // ÎßåÏïΩ ÏÇ¨Ïö©ÏûêÍ∞Ä Î°úÍ∑∏ÏïÑÏõÉÌïòÍ±∞ÎÇò Îã§Î•∏ ÏÇ¨Ïö©ÏûêÎ°ú Î°úÍ∑∏Ïù∏ÌïòÎ©¥, Í∏∞Ï°¥Ïóê Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Îäî Îçî Ïù¥ÏÉÅ Ïú†Ìö®ÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú ÏÉàÎ°úÏö¥ ÏÇ¨Ïö©ÏûêÏóê ÎßûÎäî Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìú 

   // ÌåîÎ°úÏûâ Î¶¨Ïä§Ìä∏
  const getFollowingList = async () => {
    if (user?.uid) {
      const userSnap = await getDoc(doc(db, 'Users', user?.uid))

      if (userSnap.exists()) {
        //ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥†, 
        const userData = userSnap.data();
        const followingIds: string[] = userData.following || [];

         // ÌåîÎ°úÏûâ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const followingUsers = await Promise.all(
          followingIds.map(async (id) => {
            const userDoc = await getDoc(doc(db, 'Users', id));
            if (userDoc.exists()) {
              return { id, ...userDoc.data() } as UserProps;
            }
            return null;

          })
        );
        // console.log(followingUsers)
        setFollowingList(followingUsers as UserProps[]);
      }
    }
  };

const getOtherUserInfo = async (room: ChatRoomProps): Promise<UserProps | null> => {
  if (!user || !room.users) return null;

  const otherUserId = room.users.find(userId => userId !== user.uid);
  // find Î©îÏÑúÎìúÎäî Î∞∞Ïó¥ÏóêÏÑú Ï£ºÏñ¥ÏßÑ Ï°∞Í±¥ÏùÑ ÎßåÏ°±ÌïòÎäî Ï≤´ Î≤àÏß∏ ÏöîÏÜåÎ•º Ï∞æÎäî Ìï®Ïàò. user.uidÏôÄ Í∞ôÏßÄ ÏïäÏùÄ Ï≤´ Î≤àÏß∏ ÏÇ¨Ïö©Ïûê IDÎ•º Î∞òÌôòÌïòÍ∏∞ ÏúÑÌï¥ find ÏÇ¨Ïö©Ìï® .
  if (!otherUserId) return null;

  // find Î°ú Ï∞æÏïÑÎÜìÏùÄ ÏπúÍµ¨ Users Îç∞Ïù¥ÌÑ∞ Î≤†Ïù¥Ïä§ÏóêÏÑú Ï∞æÏïÑÏò§Í∏∞
  const otherUserDocRef = doc(db, 'Users', otherUserId);
  const otherUserSnapshot = await getDoc(otherUserDocRef);

  // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Í∞Ä Ï°¥Ïû¨ÌïòÎ©¥ Î∞òÌôò
  return otherUserSnapshot.exists() ? { id: otherUserId, ...otherUserSnapshot.data() } as UserProps : null;
};

  const CloseDialog = () => {
    setOpen(false);
    setSelectedUserId(null);
  };

  const CreateNewChat = () => {
    if (selectedUserId) {
      CreateRoom(selectedUserId);
      CloseDialog();
    }
  };


  return (
    <div className='box'>
      <div style={{ padding: '10px', backgroundColor: 'transparent' }}>
        <AppBarHeader title='Chat' showBackButton={true}/>
        <div style={{ display: 'flex', justifyContent: 'flex-end'}}>
          <button onClick={() => setOpen(true)} className='newChat'> 
            <RiChatNewLine /> New Chat
          </button>
        </div>

        {chatRooms.length === 0 ? (
          <div className='noPostlist'>
            <p>ÌòÑÏû¨ Ï±ÑÌåÖÎ∞©Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
          </div>
        ) : (
          chatRooms.map((room: ChatRoomProps) => {
            const otherUser = room.otherUser;
            const unreadMessagesCount = user?.uid ? (room.unreadMessages?.[user.uid] || 0) : 0;

            return (
              <Link key={room.id} to={`/chat/${room.id}`} className='NotificationItem' style={{color: 'black', display: 'flex', alignItems: 'center', marginBottom: '10px', justifyContent: 'space-between' }}>
                <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                  {otherUser?.photoURL ? (
                    <Avatar
                      src={otherUser.photoURL}
                      alt={`${otherUser.displayName}`}
                      style={{borderRadius: '50%', width: '40px', height: '40px'}}
                    />
                  ) : (
                    <div style={{ width: '40px', height: '40px', borderRadius: '50%', backgroundColor: '#ccc' }} />
                  )}
                  <div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: "10px" }}>
                    <p style={{ fontWeight: 'bold', color: '#333' }}>{otherUser?.displayName}
                    </p>
                    <p style={{ fontSize: '12px', color: '#888' }}>{formatTimestamp(room.lastMessageTimestamp)}</p>
                  </div>
                  <p className='lastmsg'>
                    {room?.lastMessage}
                  </p>
                  </div>
                </div>
                <div style={{ marginRight: '10px', display: 'flex', flexDirection: 'column', gap: '10px', alignItems: 'center' }}>
                  
                  <p>{unreadMessagesCount > 0 && (
                  <Badge badgeContent={unreadMessagesCount} color='error' />
                )}</p>
                </div>
                    
              </Link>
            );
          })
        )}

        <AppBottomNav />

        <Dialog open={open} onClose={CloseDialog}
          PaperProps={{
            style: {
              width: '280px',
              padding: '0.5em',
              borderRadius: 8,
              boxShadow: '0px 4px 24px rgba(0, 0, 0, 0.1)',
            },
          }}
        >
          <p style={{ padding: '0.5em', textAlign: 'center', fontSize: '18px', fontWeight: 'bold' }}> üòé ÌåîÎ°úÏûâ Î¶¨Ïä§Ìä∏ÏóêÏÑú ÏÑ†ÌÉù </p>
          <DialogContent sx={{ padding: '0 12px'}}>
            <FormControl fullWidth margin="normal">
              <Select
                value={selectedUserId || ''}
                onChange={(e) => setSelectedUserId(e.target.value as string)}
                displayEmpty
                sx={{
                  '&.Mui-focused .MuiOutlinedInput-notchedOutline': { borderColor: '#580Ef6' },
                  boxShadow: '0px 0px 1px 0px rgba(0,0,0,0.1)',
                }}
                inputProps={{ sx: { display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '5px', padding: '12px' } }}
              >
                <MenuItem sx={{ fontSize: '14px'}} value="" disabled>ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù</MenuItem>
                {followingList.map(user => (
                  <MenuItem key={user.id} value={user.id} sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '5px' }}>
                    {user.photoURL && (
                      <img 
                        src={user.photoURL} 
                        alt={`${user.displayName}'s profile`} 
                        style={{ borderRadius: '50%', width: '30px', height: '30px' }} 
                      />
                    )}
                    {user.displayName}
                  </MenuItem>
                ))}
              </Select>
            </FormControl>
          </DialogContent>
          <DialogActions sx={{ display: 'flex', justifyContent: 'center', gap: '2px' }}>
            <Button fullWidth onClick={CloseDialog} sx={{
              color: '#333',
              height: '40px',
              backgroundColor: '#efefef',
              
            }}>Ï∑®ÏÜå</Button>
            <Button fullWidth onClick={CreateNewChat} sx={{
              color: '#fff',
              height: '40px',
              backgroundColor: '#580Ef6',
              '&:hover': { backgroundColor: '#440bbf' },
            }}>ÌôïÏù∏</Button>
          </DialogActions>
        </Dialog>
      </div>
    </div>
  );
}
